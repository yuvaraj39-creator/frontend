<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programming & Math Quiz | U1 Technology Institute</title>
    <link rel="icon" type="image/png" href="img/favicon-16x16.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="config.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#800020',
                        primaryDark: '#600018',
                        accent: '#FFB6C1',
                        badgeOrange: '#FF8C00',
                    },
                    fontFamily: {
                        poppins: ['Poppins', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #FAFAFA;
            color: #333333;
        }

        .quiz-option {
            transition: all 0.2s ease;
        }

        .quiz-option:hover {
            transform: translateY(-2px);
        }

        .quiz-option.selected {
            border-color: #800020;
            background-color: rgba(128, 0, 32, 0.05);
        }

        .quiz-option.correct {
            border-color: #10B981;
            background-color: rgba(16, 185, 129, 0.1);
        }

        .quiz-option.incorrect {
            border-color: #EF4444;
            background-color: rgba(239, 68, 68, 0.1);
        }

        .progress-bar {
            transition: width 0.5s ease;
        }

        .confetti {
            position: fixed;
            width: 8px;
            height: 8px;
            background-color: #f00;
            opacity: 0;
            z-index: 1000;
            pointer-events: none;
        }

        .redeem-popup {
            animation: popIn 0.5s ease-out forwards;
        }

        @keyframes popIn {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }

            70% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .countdown {
            animation: countdown 10s linear forwards;
        }

        @keyframes countdown {
            from {
                width: 100%;
            }

            to {
                width: 0%;
            }
        }

        .loading-spinner {
            border: 4px solid rgba(128, 0, 32, 0.1);
            border-radius: 50%;
            border-top: 4px solid #800020;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .timer-bar {
            height: 6px;
            border-radius: 3px;
            transition: width 1s linear;
        }

        .timer-warning {
            background-color: #EF4444 !important;
        }

        /* Toast Notification Styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10001;
            max-width: 400px;
        }

        .toast {
            background: white;
            border-radius: 8px;
            padding: 16px 20px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #3b82f6;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.hide {
            transform: translateX(400px);
            opacity: 0;
        }

        .toast.success {
            border-left-color: #10b981;
            background: #f0fdf4;
            color: #065f46;
        }

        .toast.error {
            border-left-color: #ef4444;
            background: #fef2f2;
            color: #dc2626;
        }

        .toast.info {
            border-left-color: #3b82f6;
            background: #eff6ff;
            color: #1e40af;
        }

        .toast.warning {
            border-left-color: #f59e0b;
            background: #fffbeb;
            color: #92400e;
        }

        /* Fix for option text visibility */
        .option-text {
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            line-height: 1.5;
            flex: 1;
        }

        .question-text {
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            line-height: 1.6;
        }

        .option-radio {
            flex-shrink: 0;
            width: 24px;
            height: 24px;
            border: 2px solid #d1d5db;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            transition: all 0.2s ease;
        }

        .option-radio.selected {
            background-color: #800020;
            border-color: #800020;
        }

        .option-radio.selected i {
            display: block;
        }
    </style>
</head>

<body class="antialiased">
    <header class="sticky top-0 z-50 bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <img src="img/favicon-32x32.png" alt="logo" class="w-8 h-8">
                <span class="text-xl font-semibold text-primary">U1 Technology</span>
            </div>

            <div class="hidden md:flex space-x-8">
                <a href="index.html"
                    class="text-gray-700 hover:text-primary transition-colors relative after:absolute after:bottom-0 after:left-0 after:w-0 after:h-0.5 after:bg-primary after:transition-all hover:after:w-full">Home</a>
                <a href="courses.html"
                    class="text-gray-700 hover:text-primary transition-colors relative after:absolute after:bottom-0 after:left-0 after:w-0 after:h-0.5 after:bg-primary after:transition-all hover:after:w-full">Courses</a>
                <a href="quiz.html"
                    class="text-primary font-medium relative after:absolute after:bottom-0 after:left-0 after:w-full after:h-0.5 after:bg-primary">Quiz</a>
                <a href="index.html#contact"
                    class="text-gray-700 hover:text-primary transition-colors relative after:absolute after:bottom-0 after:left-0 after:w-0 after:h-0.5 after:bg-primary after:transition-all hover:after:w-full">Contact</a>
            </div>

            <button class="md:hidden text-gray-700 focus:outline-none">
                <i class="fas fa-bars text-2xl"></i>
            </button>
        </nav>
    </header>

    <main class="container mx-auto px-6 py-12">
        <div class="max-w-4xl mx-auto">
            <!-- Authentication Check -->
            <div id="auth-check" class="hidden bg-red-50 border border-red-200 rounded-lg p-6 mb-8 text-center">
                <div class="text-red-500 text-4xl mb-4">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <h2 class="text-xl font-bold text-red-800 mb-2">Authentication Required</h2>
                <p class="text-red-600 mb-4">Please log in to access the quiz.</p>
                <a href="index.html" class="bg-primary text-white px-6 py-2 rounded-lg font-medium hover:bg-primaryDark transition-colors">
                    Go to Login
                </a>
            </div>

            <div id="quiz-content-wrapper">
                <div class="text-center mb-12">
                    <h1 class="text-4xl font-bold text-primary mb-4">Think >> Solve >> Succeed</h1>
                    <p id="quiz-description" class="text-xl text-gray-600">Put your mind to the test — conquer all questions and claim your reward!</p>
                </div>

                <!-- Quiz Progress -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700">Progress</span>
                        <span class="text-sm font-medium text-primary" id="progress-text">0/0</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div id="progress-bar" class="progress-bar h-3 rounded-full bg-primary" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Quiz Container -->
                <div id="quiz-container" class="bg-white rounded-2xl shadow-xl p-8">
                    <!-- Loading State -->
                    <div id="loading-state" class="text-center py-12">
                        <div class="loading-spinner mb-4"></div>
                        <p class="text-gray-600">Loading quiz questions...</p>
                    </div>

                    <!-- Quiz Content -->
                    <div id="quiz-content" class="hidden">
                        <div class="mb-8">
                            <div class="flex justify-between items-center mb-4">
                                <h2 id="question-text" class="text-2xl font-bold text-gray-800 question-text"></h2>
                                <div id="timer-container" class="flex items-center">
                                    <span id="timer-text" class="text-sm font-medium text-primary mr-2">30s</span>
                                    <div class="w-24 bg-gray-200 rounded-full h-2">
                                        <div id="timer-bar" class="timer-bar h-2 rounded-full bg-primary"
                                            style="width: 100%"></div>
                                    </div>
                                </div>
                            </div>
                            <div id="question-number" class="text-sm text-gray-500 mb-2"></div>
                            <div id="question-category" class="text-sm text-primary font-medium"></div>
                        </div>

                        <div id="options-container" class="space-y-4 mb-8"></div>

                        <div class="flex justify-between items-center">
                            <button id="next-btn"
                                class="bg-primary text-white px-8 py-3 rounded-lg font-medium hover:bg-primaryDark transition-colors ml-auto">
                                Next <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                            <button id="submit-btn"
                                class="bg-green-600 text-white px-8 py-3 rounded-lg font-medium hover:bg-green-700 transition-colors hidden">
                                Submit Answers
                            </button>
                        </div>
                    </div>

                    <!-- Results -->
                    <div id="results-container" class="hidden text-center py-12">
                        <div id="success-message" class="hidden">
                            <div class="text-green-500 text-6xl mb-6">
                                <i class="fas fa-trophy"></i>
                            </div>
                            <h2 class="text-3xl font-bold text-gray-800 mb-4">Congratulations!</h2>
                            <p class="text-xl text-gray-600 mb-8">You answered all questions correctly!</p>
                            <button id="show-redeem-btn"
                                class="bg-primary text-white px-8 py-3 rounded-lg font-medium hover:bg-primaryDark transition-colors">
                                Claim Your Reward
                            </button>
                        </div>

                        <div id="failure-message" class="hidden">
                            <div class="text-red-500 text-6xl mb-6">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <h2 class="text-3xl font-bold text-gray-800 mb-4">Keep Practicing!</h2>
                            <p id="score-text" class="text-xl text-gray-600 mb-4"></p>
                            <p class="text-gray-600 mb-8">Try again to improve your score and win the reward.</p>
                            <button id="retry-btn"
                                class="bg-primary text-white px-8 py-3 rounded-lg font-medium hover:bg-primaryDark transition-colors">
                                Try Again
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Redeem Code Popup -->
    <div id="redeem-popup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="redeem-popup bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center">
                <div class="text-green-500 text-5xl mb-4">
                    <i class="fas fa-gift"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Congratulations!</h2>
                <p class="text-gray-600 mb-6">You've earned a special discount code for our courses.</p>

                <div class="bg-gradient-to-r from-primary to-primaryDark p-1 rounded-lg mb-6">
                    <div class="bg-white p-4 rounded">
                        <p class="text-sm text-gray-500 mb-1">Your discount code:</p>
                        <p id="redeem-code" class="text-2xl font-bold text-primary">LOADING...</p>
                    </div>
                </div>

                <div id="storage-warning" class="hidden bg-yellow-50 border border-yellow-200 rounded p-3 mt-4 mb-4">
                    <p class="text-yellow-800 text-sm">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <span id="warning-text">Failed to save redeem code. Please take a screenshot of this code.</span>
                    </p>
                </div>

                <div class="mb-6">
                    <p class="text-sm text-gray-500">This popup will close in:</p>
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                        <div id="countdown-bar" class="countdown h-2 rounded-full bg-primary"></div>
                    </div>
                </div>

                <!-- No close button as requested -->
            </div>
        </div>
    </div>

    <footer class="bg-gray-900 text-white pt-16 pb-8 mt-16">
        <div class="container mx-auto px-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-12">
                <div>
                    <div class="flex items-center mb-4">
                        <img src="img/favicon-32x32.png" alt="logo" class="w-8 h-8 mr-2">
                        <span class="text-xl font-semibold">U1 Technology Institute</span>
                    </div>
                    <p class="text-gray-400">Empowering the next generation of technology professionals through
                        innovative education.</p>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-4">Quick Links</h3>
                    <ul class="space-y-2">
                        <li><a href="index.html" class="text-gray-400 hover:text-white transition-colors">Home</a></li>
                        <li><a href="courses.html" class="text-gray-400 hover:text-white transition-colors">Courses</a>
                        </li>
                        <li><a href="quiz.html" class="text-gray-400 hover:text-white transition-colors">Quiz</a></li>
                        <li><a href="index.html#contact"
                                class="text-gray-400 hover:text-white transition-colors">Contact</a></li>
                    </ul>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-4">Contact Us</h3>
                    <ul class="space-y-2 text-gray-400">
                        <li class="flex items-start">
                            <i class="fas fa-envelope mt-1 mr-3"></i>
                            <span>info@u1technology.edu</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-phone-alt mt-1 mr-3"></i>
                            <span>+91 9876543210</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-map-marker-alt mt=1 mr-3"></i>
                            <span>123 Tech Park, Bangalore, India</span>
                        </li>
                    </ul>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-4">Follow Us</h3>
                    <div class="flex space-x-4">
                        <a href="#"
                            class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center text-white hover:bg-primary transition-colors">
                            <i class="fab fa-facebook-f"></i>
                        </a>
                        <a href="#"
                            class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center text-white hover:bg-primary transition-colors">
                            <i class="fab fa-twitter"></i>
                        </a>
                        <a href="#"
                            class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center text-white hover:bg-primary transition-colors">
                            <i class="fab fa-linkedin-in"></i>
                        </a>
                        <a href="#"
                            class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center text-white hover:bg-primary transition-colors">
                            <i class="fab fa-instagram"></i>
                        </a>
                    </div>
                </div>
            </div>

            <div class="border-t border-gray-800 mt-12 pt-8 text-center text-gray-500">
                <p>© 2025 U1 Technology Institute. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Quiz state
        let quizData = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let score = 0;
        let timerInterval;
        let timeLeft = 30;
        let currentUser = null;
        let totalQuestions = 10;
        let questionsCache = null;
        let cacheTimestamp = null;
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

        // DOM elements
        const authCheck = document.getElementById('auth-check');
        const quizContentWrapper = document.getElementById('quiz-content-wrapper');
        const quizContainer = document.getElementById('quiz-container');
        const loadingState = document.getElementById('loading-state');
        const quizContent = document.getElementById('quiz-content');
        const questionText = document.getElementById('question-text');
        const questionNumber = document.getElementById('question-number');
        const questionCategory = document.getElementById('question-category');
        const optionsContainer = document.getElementById('options-container');
        const nextBtn = document.getElementById('next-btn');
        const submitBtn = document.getElementById('submit-btn');
        const resultsContainer = document.getElementById('results-container');
        const successMessage = document.getElementById('success-message');
        const failureMessage = document.getElementById('failure-message');
        const scoreText = document.getElementById('score-text');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const redeemPopup = document.getElementById('redeem-popup');
        const redeemCode = document.getElementById('redeem-code');
        const showRedeemBtn = document.getElementById('show-redeem-btn');
        const countdownBar = document.getElementById('countdown-bar');
        const retryBtn = document.getElementById('retry-btn');
        const timerText = document.getElementById('timer-text');
        const timerBar = document.getElementById('timer-bar');
        const storageWarning = document.getElementById('storage-warning');
        const warningText = document.getElementById('warning-text');
        const quizDescription = document.getElementById('quiz-description');

        // Toast Notification System
        const toastUtils = {
            createToast(message, type = 'info') {
                let toastContainer = document.querySelector('.toast-container');
                if (!toastContainer) {
                    toastContainer = document.createElement('div');
                    toastContainer.className = 'toast-container';
                    document.body.appendChild(toastContainer);
                }

                const toast = document.createElement('div');
                toast.className = `toast ${type}`;

                toast.innerHTML = `
                    <span>${message}</span>
                `;

                toastContainer.appendChild(toast);

                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);

                setTimeout(() => {
                    this.removeToast(toast);
                }, 5000);

                return toast;
            },

            removeToast(toast) {
                toast.classList.remove('show');
                toast.classList.add('hide');

                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            },

            showSuccess(message) {
                return this.createToast(message, 'success');
            },

            showError(message) {
                return this.createToast(message, 'error');
            },

            showInfo(message) {
                return this.createToast(message, 'info');
            },

            showWarning(message) {
                return this.createToast(message, 'warning');
            }
        };

        // Check if user is logged in
        function checkUserAuthentication() {
            const authToken = localStorage.getItem('authToken');
            const userData = localStorage.getItem('userData');

            if (!authToken || !userData) {
                console.log("User not authenticated, showing auth check");
                authCheck.classList.remove('hidden');
                quizContentWrapper.classList.add('hidden');
                return false;
            }

            try {
                currentUser = JSON.parse(userData);
                console.log("User authenticated:", currentUser);
                
                if (!currentUser.userId && currentUser._id) {
                    currentUser.userId = currentUser._id;
                }
                if (!currentUser.name && currentUser.userName) {
                    currentUser.name = currentUser.userName;
                }
                if (!currentUser.email && currentUser.userEmail) {
                    currentUser.email = currentUser.userEmail;
                }
                
                authCheck.classList.add('hidden');
                quizContentWrapper.classList.remove('hidden');
                return true;
            } catch (error) {
                console.error("Error parsing user data:", error);
                authCheck.classList.remove('hidden');
                quizContentWrapper.classList.add('hidden');
                return false;
            }
        }

        // Initialize the quiz
        document.addEventListener('DOMContentLoaded', function () {
            console.log("Quiz initialization started...");

            if (!checkUserAuthentication()) {
                return;
            }

            loadQuizData();

            // Event listeners
            nextBtn.addEventListener('click', showNextQuestion);
            submitBtn.addEventListener('click', submitQuiz);
            showRedeemBtn.addEventListener('click', showRedeemPopup);
            retryBtn.addEventListener('click', resetQuiz);
        });

        // Load quiz questions from API
        async function loadQuizData() {
            try {
                console.log("Loading quiz data...");
                
                // Check cache first
                if (questionsCache && cacheTimestamp && (Date.now() - cacheTimestamp) < CACHE_DURATION) {
                    console.log("Using cached questions");
                    quizData = [...questionsCache];
                } else {
                    quizData = await fetchQuizData();
                    // Cache the questions
                    questionsCache = [...quizData];
                    cacheTimestamp = Date.now();
                }
                
                totalQuestions = quizData.length;

                // Update quiz description with dynamic question count
                quizDescription.textContent = `Put your mind to the test — conquer all ${totalQuestions} questions and claim your reward!`;

                // Log all questions and answers for testing
                console.log("All Questions Loaded:");
                quizData.forEach((q, index) => {
                    console.log(`Q${index + 1}: ${q.question}`);
                    console.log(`  Options: ${q.options.join(', ')}`);
                    console.log(`  Correct Answer: ${q.correctAnswer}`);
                    console.log(`  Category: ${q.category}`);
                });

                // Initialize user answers array
                userAnswers = new Array(totalQuestions).fill(null);

                // Hide loading state and show quiz content
                loadingState.classList.add('hidden');
                quizContent.classList.remove('hidden');

                // Display the first question
                showQuestion(currentQuestionIndex);
                updateProgress();
            } catch (error) {
                console.error('Error loading quiz data:', error);
                loadingState.innerHTML = `
                    <div class="text-red-500 text-6xl mb-4">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800 mb-2">Failed to Load Quiz</h2>
                    <p class="text-gray-600 mb-4">Please check your connection and try again.</p>
                    <button onclick="loadQuizData()" class="bg-primary text-white px-6 py-2 rounded-lg font-medium hover:bg-primaryDark transition-colors">
                        Retry
                    </button>
                `;
            }
        }

        // Fetch quiz questions from API with better error handling and caching
        async function fetchQuizData() {
            try {
                console.log('Fetching questions from API...');

                // Use mixed categories in single call
                const response = await fetch('https://opentdb.com/api.php?amount=1&type=multiple');

                if (!response.ok) {
                    if (response.status === 429) {
                        console.warn('API rate limit reached, using fallback questions');
                        throw new Error('Rate limit exceeded');
                    }
                    throw new Error(`API responded with error status: ${response.status}`);
                }

                const data = await response.json();

                if (data.response_code !== 0 || !data.results || data.results.length === 0) {
                    throw new Error('No questions received from API');
                }

                console.log('Successfully fetched questions:', data.results.length);

                // Format questions with proper category mapping
                const formattedQuestions = data.results.map((q, index) => {
                    let category = "General Knowledge";
                    
                    // Proper category mapping
                    if (q.category.includes("Science: Mathematics") || q.category.includes("Math")) {
                        category = "Mathematics";
                    } else if (q.category.includes("Science: Computers") || q.category.includes("Programming") || 
                               q.category.includes("Computer")) {
                        category = "Programming";
                    } else if (q.category.includes("Science")) {
                        category = "Science";
                    } else if (q.category.includes("Entertainment")) {
                        category = "Entertainment";
                    } else if (q.category.includes("History")) {
                        category = "History";
                    }
                    
                    // Clean up category name
                    category = category.replace(/^[^:]+:\s*/, '');

                    return {
                        id: index + 1,
                        question: decodeHtmlEntities(q.question),
                        options: shuffleArray([
                            ...q.incorrect_answers.map(a => decodeHtmlEntities(a)),
                            decodeHtmlEntities(q.correct_answer)
                        ]),
                        correctAnswer: decodeHtmlEntities(q.correct_answer),
                        category: category
                    };
                });

                return formattedQuestions;

            } catch (error) {
                console.error('Error fetching from API:', error);
                console.log('Using fallback questions...');
                return getFallbackQuestions();
            }
        }

        // Fallback questions if API fails
        function getFallbackQuestions() {
            return shuffleArray([
                {
                    id: 1,
                    question: "What does HTML stand for?",
                    options: [
                        "Hyper Text Markup Language",
                        "High Tech Modern Language",
                        "Hyper Transfer Markup Language",
                        "Home Tool Markup Language"
                    ],
                    correctAnswer: "Hyper Text Markup Language",
                    category: "Programming"
                },
                {
                    id: 2,
                    question: "Which CSS property is used to change the text color?",
                    options: [
                        "text-color",
                        "font-color",
                        "color",
                        "text-style"
                    ],
                    correctAnswer: "color",
                    category: "Programming"
                },
                {
                    id: 3,
                    question: "Which JavaScript method is used to select an HTML element by its id?",
                    options: [
                        "document.querySelector()",
                        "document.getElementById()",
                        "document.getElementByClass()",
                        "document.findElement()"
                    ],
                    correctAnswer: "document.getElementById()",
                    category: "Programming"
                },
                {
                    id: 4,
                    question: "What is the purpose of the 'alt' attribute in an image tag?",
                    options: [
                        "To add a caption below the image",
                        "To specify alternative text for screen readers",
                        "To set the image alignment",
                        "To define the image source"
                    ],
                    correctAnswer: "To specify alternative text for screen readers",
                    category: "Programming"
                },
                {
                    id: 5,
                    question: "Which HTML tag is used to create a hyperlink?",
                    options: [
                        "<link>",
                        "<a>",
                        "<href>",
                        "<hyperlink>"
                    ],
                    correctAnswer: "<a>",
                    category: "Programming"
                },
                {
                    id: 6,
                    question: "What is the value of π (pi) to two decimal places?",
                    options: [
                        "3.12",
                        "3.14",
                        "3.16",
                        "3.18"
                    ],
                    correctAnswer: "3.14",
                    category: "Mathematics"
                },
                {
                    id: 7,
                    question: "What is the area of a rectangle with length 8 and width 5?",
                    options: [
                        "13",
                        "30",
                        "40",
                        "45"
                    ],
                    correctAnswer: "40",
                    category: "Mathematics"
                },
                {
                    id: 8,
                    question: "Solve for x: 2x + 5 = 15",
                    options: [
                        "5",
                        "10",
                        "7.5",
                        "8"
                    ],
                    correctAnswer: "5",
                    category: "Mathematics"
                },
                {
                    id: 9,
                    question: "What is 15% of 200?",
                    options: [
                        "15",
                        "20",
                        "30",
                        "25"
                    ],
                    correctAnswer: "30",
                    category: "Mathematics"
                },
                {
                    id: 10,
                    question: "What is the square root of 144?",
                    options: [
                        "11",
                        "12",
                        "13",
                        "14"
                    ],
                    correctAnswer: "12",
                    category: "Mathematics"
                }
            ]);
        }

        // Display a question
        function showQuestion(index) {
            clearInterval(timerInterval);
            timeLeft = 30;

            const question = quizData[index];

            // Update question text and number
            questionText.textContent = question.question;
            questionNumber.textContent = `Question ${index + 1} of ${totalQuestions}`;
            questionCategory.textContent = question.category;

            // Reset timer completely
            timerText.textContent = `${timeLeft}s`;
            timerBar.style.width = '100%';
            timerBar.style.backgroundColor = ''; // Reset color
            timerBar.classList.remove('timer-warning');

            // Clear options container
            optionsContainer.innerHTML = '';

            // Create option elements with robust structure
            question.options.forEach((option, optionIndex) => {
                const optionElement = document.createElement('div');
                optionElement.className = `quiz-option border-2 border-gray-200 rounded-lg p-4 cursor-pointer transition-all ${userAnswers[index] === optionIndex ? 'selected' : ''}`;
                optionElement.dataset.optionIndex = optionIndex;
                optionElement.innerHTML = `
                    <div class="flex items-start">
                        <div class="option-radio ${userAnswers[index] === optionIndex ? 'selected' : ''}">
                            <i class="fas fa-check text-white text-xs" style="display: ${userAnswers[index] === optionIndex ? 'block' : 'none'}"></i>
                        </div>
                        <span class="option-text">${option}</span>
                    </div>
                `;

                optionElement.addEventListener('click', () => selectOption(optionIndex));
                optionsContainer.appendChild(optionElement);
            });

            // Update navigation buttons with validation
            const hasAnswer = userAnswers[index] !== null;
            nextBtn.classList.toggle('hidden', index === totalQuestions - 1);
            submitBtn.classList.toggle('hidden', index !== totalQuestions - 1);
            
            // Disable submit if no answer selected
            if (index === totalQuestions - 1) {
                submitBtn.disabled = !hasAnswer;
                submitBtn.classList.toggle('opacity-50', !hasAnswer);
                submitBtn.classList.toggle('cursor-not-allowed', !hasAnswer);
            }

            // Start timer
            startTimer();

            console.log(`Displaying Question ${index + 1}: ${question.question}`);
        }

        // Start timer for current question
        function startTimer() {
            clearInterval(timerInterval);
            timeLeft = 30;

            timerInterval = setInterval(() => {
                timeLeft--;
                timerText.textContent = `${timeLeft}s`;
                timerBar.style.width = `${(timeLeft / 30) * 100}%`;

                // Change color to red when time is running out
                if (timeLeft <= 10) {
                    timerBar.classList.add('timer-warning');
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    console.log(`Time's up for question ${currentQuestionIndex + 1}`);

                    // Auto-move to next question when time is up, but don't submit if no answer
                    if (currentQuestionIndex < totalQuestions - 1) {
                        toastUtils.showInfo("Time's up! Moving to next question.");
                        currentQuestionIndex++;
                        showQuestion(currentQuestionIndex);
                    } else {
                        // If it's the last question and time's up, only submit if answered
                        if (userAnswers[currentQuestionIndex] !== null) {
                            console.log("Last question time's up, submitting quiz...");
                            submitQuiz();
                        } else {
                            toastUtils.showWarning("Time's up! Please select an answer to submit.");
                            // Keep them on the last question to force an answer
                        }
                    }
                }
            }, 1000);
        }

        // Select an option with robust selection
        function selectOption(optionIndex) {
            console.log(`Question ${currentQuestionIndex + 1}: Selected option ${optionIndex}`);
            
            // Store previous answer to update progress correctly
            const previousAnswer = userAnswers[currentQuestionIndex];
            userAnswers[currentQuestionIndex] = optionIndex;
            
            // Update UI with robust selection
            const options = optionsContainer.querySelectorAll('.quiz-option');
            options.forEach((option, index) => {
                const radio = option.querySelector('.option-radio');
                const icon = radio.querySelector('i');
                
                if (index === optionIndex) {
                    option.classList.add('selected');
                    radio.classList.add('selected');
                    icon.style.display = 'block';
                } else {
                    option.classList.remove('selected');
                    radio.classList.remove('selected');
                    icon.style.display = 'none';
                }
            });
            
            // Enable/disable submit button on last question
            if (currentQuestionIndex === totalQuestions - 1) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            updateProgress();
        }

        // Show next question
        function showNextQuestion() {
            if (userAnswers[currentQuestionIndex] === null) {
                toastUtils.showWarning("Please select an answer before proceeding to the next question");
                return;
            }

            console.log(`Moving from question ${currentQuestionIndex + 1} to ${currentQuestionIndex + 2}`);
            if (currentQuestionIndex < totalQuestions - 1) {
                currentQuestionIndex++;
                showQuestion(currentQuestionIndex);
            }
        }

        // Update progress bar
        function updateProgress() {
            const answeredCount = userAnswers.filter(answer => answer !== null).length;
            const progress = (answeredCount / totalQuestions) * 100;

            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${answeredCount}/${totalQuestions}`;

            console.log(`Progress updated: ${answeredCount}/${totalQuestions} (${progress}%)`);
        }

        // Submit the quiz
        function submitQuiz() {
            // Final validation
            if (userAnswers[currentQuestionIndex] === null) {
                toastUtils.showWarning("Please select an answer for the current question before submitting");
                return;
            }

            clearInterval(timerInterval);

            console.log("Submitting quiz...");
            console.log("User answers:", userAnswers);

            // Calculate score with text normalization
            score = 0;
            quizData.forEach((question, index) => {
                const userAnswerIndex = userAnswers[index];
                if (userAnswerIndex === null) {
                    console.log(`Q${index + 1}: Not answered`);
                    return;
                }

                const userAnswer = question.options[userAnswerIndex];
                const isCorrect = normalizeText(userAnswer) === normalizeText(question.correctAnswer);

                if (isCorrect) {
                    score++;
                }

                console.log(`Q${index + 1}: User: "${userAnswer}" | Correct: "${question.correctAnswer}" | ${isCorrect ? "CORRECT" : "WRONG"}`);
            });

            console.log(`Final Score: ${score}/${totalQuestions}`);

            // Hide quiz content and show results
            quizContent.classList.add('hidden');
            resultsContainer.classList.remove('hidden');

            // Show appropriate message
            if (score === totalQuestions) {
                successMessage.classList.remove('hidden');
                failureMessage.classList.add('hidden');
                console.log("Perfect score! Showing success message.");
                createConfetti();
            } else {
                failureMessage.classList.remove('hidden');
                successMessage.classList.add('hidden');
                scoreText.textContent = `You scored ${score} out of ${totalQuestions}.`;
                console.log(`Score: ${score}/${totalQuestions}. Showing failure message.`);
            }
        }

        // Function to store redeem code in database
        async function storeRedeemCode(redeemCode, score, totalQuestions) {
            try {
                const authToken = localStorage.getItem('authToken');
                
                if (!authToken) {
                    return { success: false, message: 'Authentication failed. Please log in again.' };
                }

                // Get user data with proper fallbacks
                let userData = null;
                try {
                    const userDataStr = localStorage.getItem('userData');
                    if (userDataStr) {
                        userData = JSON.parse(userDataStr);
                    }
                } catch (e) {
                    console.error('Error parsing user data:', e);
                }

                // Create consistent user data structure
                const userPayload = {
                    userId: (userData?.userId || userData?._id || `user_${Date.now()}`).toString(),
                    userName: userData?.name || userData?.userName || 'Quiz Participant',
                    userEmail: userData?.email || userData?.userEmail || `user${Date.now()}@example.com`
                };

                // Validate required fields
                if (!userPayload.userId || !userPayload.userName || !userPayload.userEmail) {
                    return { success: false, message: 'Missing user information. Please log in again.' };
                }

                const payload = {
                    ...userPayload,
                    score: score,
                    totalQuestions: totalQuestions,
                    redeemCode: redeemCode,
                    quizType: 'programming_math',
                    timestamp: new Date().toISOString()
                };

                console.log('Storing redeem code with payload:', payload);

                const API_BASE_URL = window.AppConfig.API_BASE_URL;

                const response = await fetch(`${API_BASE_URL}/api/quiz/redeem`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                return data;

            } catch (error) {
                console.error('Error storing redeem code:', error);
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    return { success: false, message: 'Network error. Please check your internet connection.' };
                } else {
                    return { success: false, message: 'Unexpected error occurred. Please try again.' };
                }
            }
        }

        // Show redeem code popup
        async function showRedeemPopup() {
            console.log("Showing redeem popup");

            // Generate a random redeem code
            const code = generateRedeemCode();
            redeemCode.textContent = code;

            // Show popup immediately
            redeemPopup.classList.remove('hidden');
            storageWarning.classList.add('hidden');

            let storageResult = null;
            let storageCompleted = false;

            // Store the redeem code in database with timeout protection
            const storagePromise = storeRedeemCode(code, score, totalQuestions)
                .then(result => {
                    storageResult = result;
                    storageCompleted = true;
                    
                    if (result.success) {
                        console.log('Redeem code stored successfully');
                        toastUtils.showSuccess('Redeem code saved successfully!');
                    } else {
                        console.warn("Failed to store redeem code:", result.message);
                        storageWarning.classList.remove('hidden');
                        warningText.textContent = `Failed to save redeem code: ${result.message}. Please take a screenshot.`;
                        toastUtils.showError('Failed to save redeem code: ' + result.message);
                    }
                })
                .catch(error => {
                    console.error('Storage error:', error);
                    storageCompleted = true;
                    storageWarning.classList.remove('hidden');
                    warningText.textContent = 'Storage error. Please take a screenshot of this code.';
                });

            // Reset and start countdown
            countdownBar.style.width = '100%';
            countdownBar.classList.remove('countdown');
            void countdownBar.offsetWidth;
            countdownBar.classList.add('countdown');

            // Wait for storage to complete or timeout
            const timeoutPromise = new Promise(resolve => {
                setTimeout(() => {
                    if (!storageCompleted) {
                        console.log('Storage timeout reached');
                        storageWarning.classList.remove('hidden');
                        warningText.textContent = 'Taking longer than expected. Please take a screenshot of this code.';
                    }
                    resolve();
                }, 8000); // 8 second timeout
            });

            await Promise.race([storagePromise, timeoutPromise]);

            // Wait additional time for user to see the code
            await new Promise(resolve => setTimeout(resolve, 2000));

            // Close popup and redirect if storage was successful
            closeRedeemPopup();
            if (storageResult?.success) {
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 500);
            }
        }

        // Close redeem code popup
        function closeRedeemPopup() {
            console.log("Closing redeem popup");
            redeemPopup.classList.add('hidden');
        }

        // Generate a random redeem code with variety
        function generateRedeemCode() {
            const prefixes = ['U1TECH', 'CODEU1', 'LEARNU1', 'TECHU1', 'SKILLU1'];
            const suffixes = ['QUIZ', 'WIN', 'REWARD', 'LEARN', 'SKILL'];
            const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const numbers = '0123456789';

            const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
            const suffix = suffixes[Math.floor(Math.random() * suffixes.length)];
            
            let code = `${prefix}-`;

            // Generate 6-8 character code
            const codeLength = 6 + Math.floor(Math.random() * 3);
            for (let i = 0; i < codeLength; i++) {
                const chars = Math.random() > 0.3 ? uppercase : numbers;
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }

            code += `-${suffix}`;

            console.log(`Generated redeem code: ${code}`);
            return code;
        }

        // Reset the quiz completely
        function resetQuiz() {
            console.log("Resetting quiz");
            currentQuestionIndex = 0;
            userAnswers = new Array(totalQuestions).fill(null);
            score = 0;

            // Clear cache to get new questions
            questionsCache = null;
            cacheTimestamp = null;

            // Hide results and show loading
            resultsContainer.classList.add('hidden');
            successMessage.classList.add('hidden');
            failureMessage.classList.add('hidden');
            quizContent.classList.add('hidden');
            loadingState.classList.remove('hidden');

            // Reload fresh questions
            loadQuizData();
        }

        // Create optimized confetti effect
        function createConfetti() {
            console.log("Creating optimized confetti effect");
            const colors = ['#800020', '#FFB6C1', '#FF8C00', '#10B981', '#3B82F6', '#EAB308'];
            const container = document.body;
            const confettiCount = window.innerWidth < 768 ? 50 : 80; // Less on mobile

            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.top = '-10px';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                container.appendChild(confetti);

                // Optimized animation
                const animation = confetti.animate([
                    { transform: `translateY(0) rotate(0deg)`, opacity: 1 },
                    { transform: `translateY(${window.innerHeight}px) rotate(${Math.random() * 360}deg)`, opacity: 0 }
                ], {
                    duration: 1500 + Math.random() * 2000,
                    easing: 'cubic-bezier(0.1, 0.8, 0.3, 1)'
                });

                animation.onfinish = () => confetti.remove();
            }
        }

        // Utility functions
        function decodeHtmlEntities(text) {
            if (!text) return '';
            
            const textArea = document.createElement('textarea');
            textArea.innerHTML = text;
            
            let decoded = textArea.value
                .replace(/&quot;/g, '"')
                .replace(/&amp;/g, '&')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&#039;/g, "'")
                .replace(/&ldquo;/g, '"')
                .replace(/&rdquo;/g, '"')
                .replace(/&lsquo;/g, "'")
                .replace(/&rsquo;/g, "'")
                .replace(/&nbsp;/g, ' ')
                .replace(/&times;/g, '×')
                .replace(/&divide;/g, '÷')
                .replace(/&frasl;/g, '/')
                .replace(/&#(\d+);/g, (match, dec) => String.fromCharCode(dec));
            
            return decoded;
        }

        function normalizeText(text) {
            return text
                .toLowerCase()
                .trim()
                .replace(/\s+/g, ' ')
                .replace(/[^\w\s]/g, '')
                .replace(/\s+/g, ' ');
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
    </script>
</body>

</html>